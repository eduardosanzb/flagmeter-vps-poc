# ============================================================================
# PostgreSQL Configuration for FlagMeter
# ============================================================================
#
# Optimized for heavy write workload (INSERT ... ON CONFLICT upserts)
# Target: 500+ RPS sustained, 2000+ TPS
#
# DEPLOYMENT:
# - Uncomment the section matching your server size (CAX21 or CAX11)
# - Mount as volume: -v ./infra/postgres/postgresql.conf:/etc/postgresql/postgresql.conf
# - Start with: postgres -c config_file=/etc/postgresql/postgresql.conf
#
# CRITICAL FIXES for 103% CPU issue:
# 1. synchronous_commit=off → 2-3x write throughput (40-60% CPU reduction)
# 2. Large WAL sizes → Reduce checkpoint frequency (smooth I/O spikes)
# 3. Aggressive bgwriter → Prevent checkpoint storms
#
# ============================================================================


# ============================================================================
# SERVER SIZE CONFIGURATION
# ============================================================================
# Uncomment ONE section below based on your server

# ---------- CAX21: 4 vCPU, 8GB RAM (Load Testing / High Traffic) ----------
# Target: 800-1000 RPS sustained
shared_buffers = 1GB                # 12.5% of RAM (PostgreSQL data cache)
effective_cache_size = 4GB          # OS + PG cache estimate for query planner
maintenance_work_mem = 256MB        # For CREATE INDEX, VACUUM, ALTER TABLE
work_mem = 16MB                     # Per-operation sort/hash memory
max_worker_processes = 4            # Match vCPU count
max_parallel_workers_per_gather = 2 # Parallel query workers per gather node
max_parallel_workers = 4            # Total parallel query workers
autovacuum_max_workers = 3          # Concurrent autovacuum processes
max_connections = 100               # Dashboard + workers + exporters + overhead

# ---------- CAX11: 2 vCPU, 4GB RAM (Production / Cost Optimized) ----------
# Target: 400-500 RPS sustained
# Uncomment these lines and comment out CAX21 section above when downgrading:
#
# shared_buffers = 512MB
# effective_cache_size = 2GB
# maintenance_work_mem = 128MB
# work_mem = 8MB
# max_worker_processes = 2
# max_parallel_workers_per_gather = 1
# max_parallel_workers = 2
# autovacuum_max_workers = 2
# max_connections = 50


# ============================================================================
# WAL (Write-Ahead Log) CONFIGURATION
# ============================================================================
# These settings are CRITICAL for fixing CPU saturation and rollback spikes
# All settings work for both CAX21 and CAX11

# WAL Size Limits (reduces checkpoint frequency)
max_wal_size = 3GB                  # Allow more WAL before checkpoint (was 1GB)
min_wal_size = 1GB                  # Keep recycled segments (fixes "avg 1" recycling)

# Checkpoint Timing
checkpoint_timeout = 900            # 15 min between checkpoints (was 5min = 300s)
checkpoint_completion_target = 0.9  # Spread checkpoint I/O over 90% of interval

# WAL Performance
wal_compression = on                # Compress WAL records (reduce I/O bandwidth)
wal_buffers = 16MB                  # WAL write buffer (auto = -1 also fine)
wal_writer_delay = 200ms            # Batch WAL writes every 200ms (reduce syscalls)

# ** MOST CRITICAL SETTING FOR CPU REDUCTION **
# This single setting fixes your 103% CPU → ~50-60% CPU issue
# Trade-off: Can lose last ~200-500ms of transactions on crash
# Acceptable for: Metrics, analytics, non-financial data
# NOT acceptable for: Financial transactions, user account changes
synchronous_commit = off            # Don't wait for fsync() on commit

# Alternative (safer but slower): synchronous_commit = local
# Gives ~60% of performance benefit with less data loss risk


# ============================================================================
# BACKGROUND WRITER
# ============================================================================
# Proactively writes dirty buffers to smooth checkpoint I/O spikes
bgwriter_delay = 200ms              # Write dirty buffers every 200ms
bgwriter_lru_maxpages = 100         # Max pages to write per round (default 100)
bgwriter_lru_multiplier = 2.0       # Write 2x estimated buffer usage (default 2.0)


# ============================================================================
# QUERY PLANNER
# ============================================================================
# Assumes SSD storage (Hetzner uses NVMe SSDs)
random_page_cost = 1.1              # SSD random access cost (default 4.0 is HDD)
seq_page_cost = 1.0                 # Sequential read cost baseline
effective_io_concurrency = 200      # SSD can handle many concurrent I/O ops


# ============================================================================
# AUTOVACUUM
# ============================================================================
# Aggressive tuning for heavy write workload (critical for INSERT ... ON CONFLICT)
autovacuum = on                     # Essential - do not disable!
autovacuum_naptime = 30s            # Check for vacuum every 30s (default 1min)
autovacuum_vacuum_cost_limit = 1000 # Process faster (default 200)
autovacuum_vacuum_scale_factor = 0.1    # Vacuum after 10% of table changes (default 0.2)
autovacuum_analyze_scale_factor = 0.05  # Analyze after 5% of table changes (default 0.1)


# ============================================================================
# LOGGING (Adjust for debugging)
# ============================================================================
log_destination = 'stderr'
logging_collector = off             # Use Docker logs instead
log_min_duration_statement = 1000   # Log queries slower than 1s (1000ms)
log_checkpoints = on                # Log checkpoint stats (useful for monitoring)
log_connections = off               # Disable to reduce log noise
log_disconnections = off
log_lock_waits = on                 # Log lock waits > deadlock_timeout
log_temp_files = 0                  # Log all temp file usage (helps find bad queries)


# ============================================================================
# LOCALE AND FORMATTING
# ============================================================================
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'


# ============================================================================
# MONITORING EXTENSIONS
# ============================================================================
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 10000


# ============================================================================
# PERFORMANCE MONITORING QUERIES
# ============================================================================
# After deploying, validate settings with:
#
# -- Check if settings applied
# SELECT name, setting, unit FROM pg_settings
# WHERE name IN ('synchronous_commit', 'max_wal_size', 'shared_buffers');
#
# -- Monitor checkpoint frequency (should be ~15min apart)
# SELECT * FROM pg_stat_bgwriter;
#
# -- Check buffer cache hit ratio (should be >95%)
# SELECT
#   sum(heap_blks_hit) / nullif(sum(heap_blks_hit) + sum(heap_blks_read), 0) * 100 AS cache_hit_ratio
# FROM pg_statio_user_tables;
#
# -- Monitor WAL generation rate
# SELECT pg_wal_lsn_diff(pg_current_wal_lsn(), '0/0') / 1024 / 1024 AS wal_mb_generated;
#
# -- Find slow queries
# SELECT query, calls, mean_exec_time, max_exec_time
# FROM pg_stat_statements
# ORDER BY mean_exec_time DESC LIMIT 10;
